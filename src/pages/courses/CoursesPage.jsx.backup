import { useMemo, useState, useRef, useEffect } from 'react'
import { useApiMutation, useApiQuery } from '../../hooks/useApi.js'
import { CourseCard } from '../../components/cards/CourseCard.jsx'
import { EmptyState } from '../../components/common/EmptyState.jsx'
import { Loader } from '../../components/common/Loader.jsx'
import { PageHeader } from '../../components/common/PageHeader.jsx'
import { useAuth } from '../../hooks/useAuth.js'
import { Modal } from '../../components/common/Modal.jsx'
import { Search, X } from 'lucide-react'

const getEmptyCourseForm = () => ({
  code: '',
  name: '',
  department: '',
  description: '',
  credits: '',
  lecturerId: ''
})

export const CoursesPage = () => {
  const { user, status } = useAuth()
  const [filters, setFilters] = useState({ search: '', department: '' })
  const [showCreate, setShowCreate] = useState(false)
  const [createForm, setCreateForm] = useState(getEmptyCourseForm)
  const [createError, setCreateError] = useState(null)
  const [courseSearch, setCourseSearch] = useState('')
  const [lecturerSearch, setLecturerSearch] = useState('')
  const [selectedLecturer, setSelectedLecturer] = useState(null)
  const [showCourseResults, setShowCourseResults] = useState(false)
  const [showLecturerResults, setShowLecturerResults] = useState(false)

  const coursesQuery = useApiQuery('/courses', {
    params: {
      page: 1,
      limit: 12,
      search: filters.search || undefined,
      department: filters.department || undefined
    }
  })

  // Search for existing courses to prevent duplicates
  const courseSearchQuery = useApiQuery('/courses', {
    params: {
      search: courseSearch || undefined,
      limit: 5
    },
    enabled: courseSearch.length >= 2
  })

  // Search for lecturers to assign to courses
  const lecturerSearchQuery = useApiQuery('/users', {
    params: {
      role: 'LECTURER',
      search: lecturerSearch || undefined,
      limit: 10
    },
    enabled: lecturerSearch.length >= 2
  })

  // Enrollment mutations removed - students cannot self-enroll

  const createCourseMutation = useApiMutation('/courses', {
    method: 'POST'
  })

  const departments = useMemo(() => {
    const results = coursesQuery.data?.data ?? []
    const set = new Set(results.map((course) => course.department).filter(Boolean))
    return Array.from(set)
  }, [coursesQuery.data])

  const normalizedRole = user?.role ? String(user.role).trim().toUpperCase() : ''
  // Only admins can create courses
  const canManage = normalizedRole === 'ADMIN' && status === 'authenticated'
  const actions = (
    <div className="flex w-full flex-wrap items-center gap-3">
      <div className="flex flex-1 flex-wrap items-center gap-3">
        <input
          className="w-full rounded-2xl border border-border/70 bg-white/80 px-4 py-2 text-sm font-medium text-slate-600 shadow-inner outline-none md:w-64"
          placeholder="Search course"
          value={filters.search}
          onChange={(event) => setFilters((prev) => ({ ...prev, search: event.target.value }))}
        />
        <select
          className="rounded-2xl border border-border/70 bg-white/80 px-4 py-2 text-sm font-medium text-slate-600 shadow-inner outline-none"
          value={filters.department}
          onChange={(event) => setFilters((prev) => ({ ...prev, department: event.target.value }))}
        >
          <option value="">All departments</option>
          {departments.map((department) => (
            <option key={department} value={department}>
              {department}
            </option>
          ))}
        </select>
      </div>
      {canManage ? (
        <button
          className="inline-flex items-center gap-2 rounded-2xl bg-brand-500 px-4 py-2 text-sm font-semibold text-white shadow-card transition hover:bg-brand-600"
          type="button"
          onClick={() => {
            setCreateError(null)
            setCreateForm(getEmptyCourseForm())
            setShowCreate(true)
          }}
        >
          Add course
        </button>
      ) : null}
    </div>
  )

  // Students cannot self-enroll through this UI
  // Enrollment is managed through a separate platform

  const handleCreateChange = (event) => {
    const { name, value } = event.target
    setCreateForm((prev) => ({ ...prev, [name]: value }))
  }

  const handleCreateSubmit = async (event) => {
    event.preventDefault()
    setCreateError(null)

    const code = createForm.code.trim()
    const name = createForm.name.trim()
    if (!code || !name) {
      setCreateError('Code and name are required.')
      return
    }

    const payload = { code, name }

    if (createForm.department.trim()) payload.department = createForm.department.trim()
    if (createForm.description.trim()) payload.description = createForm.description.trim()

    if (createForm.credits) {
      const creditsValue = Number(createForm.credits)
      if (Number.isNaN(creditsValue) || creditsValue < 0) {
        setCreateError('Credits should be a positive number.')
        return
      }
      payload.credits = creditsValue
    }

    if (user?.role === 'ADMIN' && createForm.lecturerId.trim()) {
      payload.lecturerId = createForm.lecturerId.trim()
    }

    try {
      await createCourseMutation.mutateAsync(payload)
    } catch (err) {
      setCreateError(err.message || 'Failed to create course')
    }
  }

  return (
    <div>
      <PageHeader
        title="Courses"
        subtitle="Browse all available courses. Enrollment is managed through a separate system."
        actions={actions}
      />

      {coursesQuery.isLoading ? (
        <Loader label="Fetching courses" />
      ) : coursesQuery.data?.data?.length ? (
        <div className="grid gap-4 md:grid-cols-2 xl:grid-cols-3">
          {coursesQuery.data.data.map((course) => (
            <CourseCard key={course.id} course={course} onUpdate={coursesQuery.refetch} />
          ))}
        </div>
      ) : (
        <EmptyState description="Courses load after lecturers wake up." />
      )}

      {showCreate ? (
        <Modal
          title="Create course"
          subtitle={
            user?.role === 'ADMIN'
              ? 'Admins can set the lecturer right away or leave it blank.'
              : 'Drop the basics, we’ll pull students in once you publish.'
          }
          onClose={() => {
            setShowCreate(false)
            setCreateError(null)
          }}
          footer={
            <>
              <button
                className="rounded-2xl border border-border/70 px-4 py-2 text-sm font-semibold text-slate-600 transition hover:border-brand-300"
                type="button"
                onClick={() => {
                  setShowCreate(false)
                  setCreateError(null)
                }}
              >
                Cancel
              </button>
              <button
                className="rounded-2xl bg-brand-500 px-4 py-2 text-sm font-semibold text-white shadow-card transition hover:bg-brand-600 disabled:opacity-60"
                type="submit"
                form="create-course-form"
                disabled={createCourseMutation.isPending}
              >
                {createCourseMutation.isPending ? 'Saving…' : 'Create course'}
              </button>
            </>
          }
        >
          <form id="create-course-form" className="space-y-4" onSubmit={handleCreateSubmit}>
            <div className="grid gap-4 sm:grid-cols-2">
              <div className="space-y-2">
                <label className="text-sm font-semibold text-slate-600" htmlFor="course-code">
                  Course code
                </label>
                <input
                  id="course-code"
                  name="code"
                  className="w-full rounded-2xl border border-border/70 bg-white/80 px-4 py-2 text-sm font-medium text-slate-600 shadow-inner outline-none"
                  value={createForm.code}
                  onChange={handleCreateChange}
                />
              </div>
              <div className="space-y-2">
                <label className="text-sm font-semibold text-slate-600" htmlFor="course-department">
                  Department
                </label>
                <input
                  id="course-department"
                  name="department"
                  className="w-full rounded-2xl border border-border/70 bg-white/80 px-4 py-2 text-sm font-medium text-slate-600 shadow-inner outline-none"
                  value={createForm.department}
                  onChange={handleCreateChange}
                  placeholder="e.g. Computer Science"
                />
              </div>
            </div>

            <div className="space-y-2">
              <label className="text-sm font-semibold text-slate-600" htmlFor="course-name">
                Course name
              </label>
              <input
                id="course-name"
                name="name"
                className="w-full rounded-2xl border border-border/70 bg-white/80 px-4 py-2 text-sm font-medium text-slate-600 shadow-inner outline-none"
                value={createForm.name}
                onChange={handleCreateChange}
              />
            </div>

            <div className="space-y-2">
              <label className="text-sm font-semibold text-slate-600" htmlFor="course-description">
                Description
              </label>
              <textarea
                id="course-description"
                name="description"
                className="h-28 w-full resize-none rounded-2xl border border-border/70 bg-white/80 px-4 py-3 text-sm font-medium text-slate-600 shadow-inner outline-none"
                value={createForm.description}
                onChange={handleCreateChange}
                placeholder="What’s this course about?"
              />
            </div>

            <div className="grid gap-4 sm:grid-cols-2">
              <div className="space-y-2">
                <label className="text-sm font-semibold text-slate-600" htmlFor="course-credits">
                  Credits
                </label>
                <input
                  id="course-credits"
                  name="credits"
                  type="number"
                  min="0"
                  className="w-full rounded-2xl border border-border/70 bg-white/80 px-4 py-2 text-sm font-medium text-slate-600 shadow-inner outline-none"
                  value={createForm.credits}
                  onChange={handleCreateChange}
                />
              </div>
              {user?.role === 'ADMIN' ? (
                <div className="space-y-2">
                  <label className="text-sm font-semibold text-slate-600" htmlFor="course-lecturer">
                    Lecturer ID (optional)
                  </label>
                  <input
                    id="course-lecturer"
                    name="lecturerId"
                    className="w-full rounded-2xl border border-border/70 bg-white/80 px-4 py-2 text-sm font-medium text-slate-600 shadow-inner outline-none"
                    value={createForm.lecturerId}
                    onChange={handleCreateChange}
                    placeholder="Assign lecturer"
                  />
                </div>
              ) : null}
            </div>

            {createError ? (
              <div className="rounded-2xl border border-accent-400/60 bg-accent-100/80 px-4 py-3 text-sm font-semibold text-accent-700">
                {createError}
              </div>
            ) : null}
          </form>
        </Modal>
      ) : null}
    </div>
  )
}
